<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Miraculous Disney+ Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- TEMA MODERNO (Disney+ Dark Theme inspired) --- */
        :root {
            --bg-body: #0e0e10;
            --bg-header: rgba(15, 15, 20, 0.95);
            --bg-card: #1a1c23;
            --bg-card-hover: #23252e;
            --accent-primary: #00d2ff; /* Azul Disney+ */
            --accent-secondary: #ed1c24; /* Rojo Miraculous */
            --accent-new: #00fa9a; /* Verde Nuevos */
            --text-main: #f9f9f9;
            --text-muted: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
            --radius: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(circle at top center, #1a2236 0%, #0e0e10 60%);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* HEADER */
        header {
            text-align: center;
            padding: 25px 20px;
            background: var(--bg-header);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        h1 { margin: 0; font-weight: 800; font-size: 1.6rem; letter-spacing: -0.5px; text-transform: uppercase; background: linear-gradient(90deg, #fff, #a0a0a0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .last-update { font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; font-weight: 500;}

        /* --- CONTROLES --- */
        .controls-wrapper {
            max-width: 900px;
            margin: 25px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
        }

        /* Dropdown Personalizado */
        .custom-select-container { position: relative; width: 100%; }
        
        .select-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: white;
            padding: 14px 18px;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: 0.2s;
            font-weight: 500;
        }
        .select-btn:hover { border-color: var(--accent-primary); background: var(--bg-card-hover); }
        .select-btn img { margin-right: 10px; width: 24px; border-radius: 3px; }
        
        /* Lista de Opciones */
        .options-list {
            position: absolute;
            top: 115%;
            left: 0;
            right: 0;
            background: #15171e;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            max-height: 350px;
            overflow-y: auto;
            display: none;
            z-index: 200;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .custom-select-container.active .options-list { display: block; }

        .option {
            padding: 12px 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            transition: 0.1s;
        }
        .option:hover { background: rgba(0, 210, 255, 0.1); color: white; }
        .option img { width: 24px; height: 16px; object-fit: cover; border-radius: 2px; margin-right: 12px; }
        
        /* Ajuste para banderas cuadradas/raras */
        .option img.custom-flag, .select-btn img.custom-flag { width: 22px; height: auto; object-fit: contain; }

        /* Selector Temporada */
        .std-select {
            width: 100%;
            padding: 14px 18px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: var(--radius);
            font-size: 1rem;
            cursor: pointer;
            appearance: none;
            font-family: inherit;
        }
        .std-select:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- NOVEDADES (Estilo Tarjetas) --- */
        #news-banner {
            max-width: 900px;
            margin: 0 auto 30px;
            padding: 0 20px;
            display: none;
        }
        .news-header {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-new);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .news-card {
            background: rgba(0, 250, 154, 0.05); /* Verde muy suave */
            border: 1px solid rgba(0, 250, 154, 0.2);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: transform 0.2s;
        }
        .news-card:hover { transform: translateY(-2px); background: rgba(0, 250, 154, 0.1); }
        .news-card strong { display: block; color: var(--accent-new); font-size: 0.8rem; margin-bottom: 4px; }

        /* --- EPISODIOS --- */
        #main-container { max-width: 900px; margin: 0 auto; padding: 0 20px 60px; }

        .season-divider {
            margin: 50px 0 20px;
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--accent-primary);
            border-bottom: 2px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ep-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            transition: 0.2s;
        }
        .ep-card:hover { background: var(--bg-card-hover); border-color: rgba(255,255,255,0.2); }

        /* ESTILO NUEVO */
        .ep-card.is-new {
            border-color: var(--accent-new);
            box-shadow: 0 0 15px rgba(0, 250, 154, 0.1);
        }
        .ep-card.is-new::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--accent-new);
        }

        .ep-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }

        .ep-title { font-size: 1.1rem; font-weight: 600; line-height: 1.4; color: #fff; }
        .ep-num { color: var(--accent-primary); font-weight: 800; margin-right: 8px; font-size: 0.9em; }
        
        .ep-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .date-display { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; font-family: monospace; }
        
        .new-badge {
            background: var(--accent-new);
            color: #000;
            font-size: 0.7rem;
            font-weight: 800;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            animation: pulse 2s infinite;
        }

        .ep-desc {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #ccc;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* --- AUDIOS Y SUBS --- */
        .tags-row {
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 0.8rem;
        }

        .tag-pill {
            background: rgba(255,255,255,0.08);
            padding: 4px 10px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            color: #ddd;
        }
        .tag-icon { opacity: 0.6; margin-right: 6px; }

        .more-audios-btn {
            color: var(--accent-primary);
            cursor: pointer;
            margin-left: 5px;
            font-weight: 600;
            text-decoration: none;
            border-bottom: 1px dotted var(--accent-primary);
        }
        .hidden-content { display: none; }
        .hidden-content.show { display: inline; animation: fadeIn 0.3s; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- M√ìVIL --- */
        @media (max-width: 768px) {
            .controls-wrapper { grid-template-columns: 1fr; }
            
            .ep-header { flex-direction: column; } /* T√≠tulo arriba */
            
            .ep-meta { 
                margin-top: 5px; 
                width: 100%;
                justify-content: flex-start; /* Fecha a la izquierda debajo del t√≠tulo */
            }
            .date-display { font-size: 0.9rem; }
        }
    </style>
</head>
<body>

<header>
    <h1>Miraculous Disney+ Tracker</h1>
    <div class="last-update" id="ui-loading">Connecting...</div>
</header>

<div class="controls-wrapper">
    <div class="custom-select-container" id="country-dropdown">
        <div class="select-btn" onclick="toggleDropdown(event)">
            <span id="select-label" style="display:flex; align-items:center;">
                <span style="font-size:1.2rem; margin-right:10px">üåç</span> Select Region
            </span>
            <span style="font-size:0.8rem">‚ñº</span>
        </div>
        <div class="options-list" id="options-list">
            </div>
    </div>

    <select id="season-select" class="std-select" onchange="changeSeason()" disabled>
        <option value="all">All Seasons</option>
    </select>
</div>

<div id="news-banner">
    <div class="news-header">‚ú® <span id="news-title">New Episodes</span></div>
    <div class="news-grid" id="news-grid"></div>
</div>

<div id="main-container"></div>

<script>
    // === CONFIGURACI√ìN ===
    const HIDDEN_DATE_MARKER = "2000-01-01";
    
    // --- MAPA DE PRIORIDAD DE AUDIO (SEG√öN TU LISTA EXACTA) ---
    // Clave: C√≥digo de Pa√≠s (ISO) -> Valor: String EXACTO del audio a priorizar
    const AUDIO_PRIORITY = {
        // Latam
        "AR": "Espa√±ol (Latinoamericano)", "MX": "Espa√±ol (Latinoamericano)", "CL": "Espa√±ol (Latinoamericano)",
        "CO": "Espa√±ol (Latinoamericano)", "PE": "Espa√±ol (Latinoamericano)", "VE": "Espa√±ol (Latinoamericano)",
        // Europa
        "ES": "Espa√±ol", // O "Espa√±ol (Castilian)" si el script lo guarda as√≠
        "FR": "Fran√ßais", "BE": "Fran√ßais", "CH": "Fran√ßais", // Suiza a veces es aleman/frances
        "DE": "Deutsch", "AT": "Deutsch",
        "IT": "Italiano",
        "PT": "Portugu√™s", "BR": "Portugu√™s",
        "RO": "Rom√¢nƒÉ",
        "SE": "Svenska",
        "NL": "Nederlands",
        "NO": "Norsk",
        "PL": "Polski",
        "CZ": "ƒåe≈°tina",
        "TR": "T√ºrk√ße",
        "HU": "Magyar",
        "GR": "Greek",
        "DK": "Dansk",
        "FI": "Suomi",
        // Asia / Global
        "JP": "Japanese",
        "TW": "Taiwanese Mandarin",
        "HK": "Cantonese",
        "US": "English", "GB": "English", "CA": "English", "AU": "English"
    };

    // Strings de la UI
    const UI_TEXT = {
        en: { select: "Select Region", allS: "All Seasons", news: "New Episodes", loading: "Loading...", more: "more..." },
        es: { select: "Selecciona Regi√≥n", allS: "Todas las Temporadas", news: "Nuevos Episodios", loading: "Cargando...", more: "m√°s..." }
    };

    // Ajustes Visuales
    const CUSTOM_NAMES = { "GB": "Reino Unido", "FK": "Islas Malvinas (Arg.)", "US": "Estados Unidos" };
    
    // BANDERAS (PNG estables)
    const CUSTOM_FLAGS = {
        // Tierra del Fuego para Malvinas
        "FK": "https://upload.wikimedia.org/wikipedia/commons/thumb/9/97/Flag_of_Tierra_del_Fuego_province_in_Argentina.svg/320px-Flag_of_Tierra_del_Fuego_province_in_Argentina.svg.png",
        // Cruz de Borgo√±a para Gibraltar
        "GI": "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f1/Flag_of_Cross_of_Burgundy.svg/320px-Flag_of_Cross_of_Burgundy.svg.png"
    };

    // --- VARIABLES GLOBALES ---
    let db = null;
    let selectedCountry = null;
    let uiLang = 'en';

    // --- INICIO ---
    async function init() {
        // Detectar idioma navegador
        const userLang = navigator.language || navigator.userLanguage;
        if (userLang.startsWith('es')) uiLang = 'es';
        applyTexts();

        try {
            const res = await fetch('database.json?v=' + Date.now());
            if(!res.ok) throw new Error("DB not found");
            db = await res.json();
            document.getElementById('ui-loading').innerText = db.meta.updated;
            
            buildDropdown();
            checkURL();
        } catch (e) {
            document.getElementById('ui-loading').innerHTML = "<span style='color:#ff4757'>Error loading data</span>";
            console.error(e);
        }
    }

    function applyTexts() {
        const t = UI_TEXT[uiLang];
        document.getElementById('select-label').innerHTML = `<span style="font-size:1.2rem; margin-right:10px">üåç</span> ${t.select}`;
        document.getElementById('news-title').innerText = t.news;
        const sOpt = document.querySelector('#season-select option[value="all"]');
        if(sOpt) sOpt.innerText = t.allS;
    }

    // --- CONTROL DE URL Y ESTADO ---
    function checkURL() {
        const params = new URLSearchParams(window.location.search);
        const c = params.get('c');
        const s = params.get('s');

        if (c && db.regions[c]) {
            setCountry(c, false); // No updates history yet to avoid loop
            if (s) {
                const sel = document.getElementById('season-select');
                sel.value = s;
                renderEpisodes(); // Render manual
            }
        }
    }

    function updateURL(c, s) {
        const url = `?c=${c}&s=${s}`;
        window.history.replaceState(null, '', url);
    }

    // --- DROPDOWN CUSTOM ---
    function buildDropdown() {
        const list = document.getElementById('options-list');
        const sortedCodes = Object.keys(db.regions).sort((a,b) => getName(a).localeCompare(getName(b)));

        sortedCodes.forEach(code => {
            const div = document.createElement('div');
            div.className = 'option';
            
            const img = document.createElement('img');
            if (CUSTOM_FLAGS[code]) {
                img.src = CUSTOM_FLAGS[code];
                img.classList.add('custom-flag');
            } else {
                img.src = `https://flagcdn.com/24x18/${code.toLowerCase()}.png`;
            }
            
            div.innerHTML = "";
            div.appendChild(img);
            div.appendChild(document.createTextNode(getName(code)));
            
            div.onclick = () => {
                setCountry(code, true);
                toggleDropdown();
            };
            list.appendChild(div);
        });
    }

    function toggleDropdown(e) {
        if(e) e.stopPropagation();
        document.getElementById('country-dropdown').classList.toggle('active');
    }
    
    window.onclick = () => document.getElementById('country-dropdown').classList.remove('active');

    // --- L√ìGICA DE SELECCI√ìN ---
    function setCountry(code, updateHistory) {
        selectedCountry = code;
        
        // Actualizar bot√≥n visual
        const label = document.getElementById('select-label');
        const flagSrc = CUSTOM_FLAGS[code] || `https://flagcdn.com/24x18/${code.toLowerCase()}.png`;
        const flagClass = CUSTOM_FLAGS[code] ? 'custom-flag' : '';
        label.innerHTML = `<img src="${flagSrc}" class="${flagClass}" style="width:24px; margin-right:10px; border-radius:3px"> ${getName(code)}`;

        // Llenar temporadas
        const sSelect = document.getElementById('season-select');
        sSelect.innerHTML = `<option value="all">${UI_TEXT[uiLang].allS}</option>`;
        sSelect.disabled = false;
        
        db.regions[code].seasons.forEach(s => {
            sSelect.innerHTML += `<option value="${s.id}">Temporada ${s.id}</option>`;
        });
        sSelect.value = 'all'; // Reset a todas

        if(updateHistory) updateURL(code, 'all');
        
        renderNews(code);
        renderEpisodes();
    }

    function changeSeason() {
        if (!selectedCountry) return;
        const sVal = document.getElementById('season-select').value;
        updateURL(selectedCountry, sVal);
        renderEpisodes();
    }

    // --- RENDERIZADO ---
    function renderNews(code) {
        const box = document.getElementById('news-banner');
        const grid = document.getElementById('news-grid');
        const items = db.regions[code].news || [];

        // Filtramos items validos (que no sean marker date)
        const validNews = items.filter(i => i.d !== HIDDEN_DATE_MARKER);

        if (validNews.length === 0) {
            box.style.display = 'none';
            return;
        }

        grid.innerHTML = '';
        validNews.slice(0, 6).forEach(n => {
            grid.innerHTML += `
                <div class="news-card">
                    <strong>${formatDate(n.d)}</strong>
                    ${n.e} - ${n.t}
                </div>
            `;
        });
        box.style.display = 'block';
    }

    function renderEpisodes() {
        const container = document.getElementById('main-container');
        container.innerHTML = '';
        const sVal = document.getElementById('season-select').value;
        
        db.regions[selectedCountry].seasons.forEach(season => {
            if (sVal !== 'all' && season.id != sVal) return;

            // Header Temporada
            const h = document.createElement('div');
            h.className = 'season-divider';
            h.innerText = `Temporada ${season.id}`;
            container.appendChild(h);

            season.eps.forEach(ep => {
                const dateVal = (ep.dt === HIDDEN_DATE_MARKER) ? '' : ep.dt;
                const isNew = checkNew(dateVal);

                // --- LOGICA DE AUDIO AVANZADA ---
                const targetAudio = AUDIO_PRIORITY[selectedCountry] || "English";
                let audios = [...ep.a];
                let primary = null;
                let others = [];

                // Buscar coincidencias (Exacta o Parcial)
                // Ej: Buscar "Espa√±ol (Latinoamericano)" en la lista ["English", "Espa√±ol (Latinoamericano)"]
                const idx = audios.findIndex(a => a === targetAudio || a.includes(targetAudio));
                
                if (idx !== -1) {
                    primary = audios[idx];
                    audios.splice(idx, 1); // Quitarlo de la lista
                    others = audios;
                } else {
                    // Si no encuentra el prioritario, usa el primero que haya
                    if(audios.length > 0) {
                        primary = audios[0];
                        others = audios.slice(1);
                    }
                }

                // Generar HTML Audio
                let audioHTML = '';
                if(primary) {
                    audioHTML = `<div class="tag-pill"><span class="tag-icon">üîä</span> ${primary}`;
                    if(others.length > 0) {
                        const uid = `aud-${season.id}-${ep.n}`;
                        audioHTML += `
                            <span id="${uid}" class="hidden-content">, ${others.join(', ')}</span>
                            <span class="more-audios-btn" onclick="document.getElementById('${uid}').classList.toggle('show'); this.style.display='none'">
                                +${others.length} ${UI_TEXT[uiLang].more}
                            </span>
                        `;
                    }
                    audioHTML += `</div>`;
                }

                // Subs
                let subHTML = '';
                if(ep.s.length > 0) {
                    // Mostrar solo 3 subs max, resto oculto si son muchos
                    const subNames = ep.s.map(x => x.l);
                    const subDisplay = subNames.slice(0, 3).join(', ');
                    const extra = subNames.length > 3 ? ` (+${subNames.length - 3})` : '';
                    subHTML = `<div class="tag-pill"><span class="tag-icon">üìù</span> ${subDisplay}${extra}</div>`;
                }

                // Card HTML
                const card = document.createElement('div');
                card.className = `ep-card ${isNew ? 'is-new' : ''}`;
                
                const badge = isNew ? `<span class="new-badge">${UI_TEXT[uiLang].news}</span>` : '';
                const dateDisplay = dateVal ? `<span class="date-display">üìÖ ${formatDate(dateVal)}</span>` : '';

                card.innerHTML = `
                    <div class="ep-header">
                        <div class="ep-title"><span class="ep-num">#${ep.n}</span> ${ep.t}</div>
                        <div class="ep-meta">
                            ${badge}
                            ${dateDisplay}
                        </div>
                    </div>
                    <div class="ep-desc">${ep.ds || ""}</div>
                    <div class="tags-row">
                        ${audioHTML}
                        ${subHTML}
                    </div>
                `;
                container.appendChild(card);
            });
        });
    }

    // --- UTILES ---
    function getName(code) { return CUSTOM_NAMES[code] || new Intl.DisplayNames([uiLang], {type:'region'}).of(code); }
    function formatDate(d) { if(!d) return ""; const p = d.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
    function checkNew(d) { if(!d) return false; const diff = (new Date() - new Date(d))/(1000*3600*24); return diff <= 90; }

    init();

</script>
</body>
</html>
