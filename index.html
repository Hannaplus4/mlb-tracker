<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miraculous Global Tracker v4</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- VARIABLES DE COLOR (TEMA OSCURO) --- */
        :root {
            --bg-main: #121212; /* Fondo principal m√°s oscuro */
            --bg-card: #1e1e2e; /* Fondo de las tarjetas */
            --accent: #ff4757; /* Rojo Miraculous (Ladybug) */
            --accent-sec: #2ed573; /* Verde para nuevos (Chat Noir eyes) */
            --text-primary: #ffffff;
            --text-secondary: #a4b0be;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        /* HEADER */
        header {
            text-align: center;
            margin-bottom: 35px;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 20px;
        }
        
        h1 { 
            margin: 0; 
            color: var(--accent); 
            font-weight: 700;
            letter-spacing: 1px;
        }
        h1 .bug { font-size: 1.2em; vertical-align: middle; }
        .last-update { font-size: 0.85rem; color: var(--text-secondary); margin-top: 10px; }

        /* CONTROLES (SELECTORES) */
        .controls-container {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 250px;
            flex: 1;
        }

        label { font-size: 0.9rem; color: var(--accent); margin-bottom: 5px; font-weight: 600;}

        select {
            padding: 12px 15px;
            background: var(--bg-main);
            border: 2px solid #333;
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: border-color 0.3s;
            appearance: none; /* Reset nativo */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 15px;
        }
        select:focus { outline: none; border-color: var(--accent); }

        /* BANDERAS EN SELECTOR */
        .flag-icon { width: 24px; height: 18px; object-fit: cover; border-radius: 3px; vertical-align: middle; margin-right: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);}
        /* Ajuste para banderas personalizadas que pueden tener otras proporciones */
        .flag-icon.custom-flag { width: auto; height: 20px; }


        /* BANNER DE NOVEDADES */
        #news-banner {
            background: linear-gradient(135deg, var(--accent), #ff6b81);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: none; /* Oculto por defecto */
            animation: slideDown 0.5s ease;
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);
        }
        #news-banner h3 { margin: 0 0 10px 0; font-size: 1.1rem; color: white; display: flex; align-items: center;}
        .news-fire { margin-right: 8px; font-size: 1.3rem; }
        .news-pill { 
            background: rgba(0,0,0,0.3); 
            padding: 5px 12px; 
            border-radius: 20px; 
            display: inline-block; 
            margin: 5px; 
            font-size: 0.9rem; 
            color: white;
            font-weight: 500;
        }

        /* --- TARJETAS DE EPISODIOS --- */
        .season-separator {
            color: var(--accent);
            font-size: 1.2rem;
            margin: 30px 0 15px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
            font-weight: 700;
        }

        .ep-card {
            background-color: var(--bg-card);
            margin-bottom: 15px;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 5px solid transparent; /* Borde izquierdo para estado */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .ep-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); background-color: #25253a;}

        /* Estado: NUEVO */
        .ep-card.is-new {
            border-left-color: var(--accent-sec);
            background: linear-gradient(to right, rgba(46, 213, 115, 0.1), var(--bg-card) 40%);
        }

        /* LAYOUT DEL ENCABEZADO DEL EPISODIO (Flexbox) */
        .ep-header {
            display: flex;
            justify-content: space-between; /* PC: T√≠tulo izquierda, fecha derecha */
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap; /* Permite que baje en m√≥vil */
        }

        .ep-title-group {
            font-size: 1.1rem;
            font-weight: 600;
            flex-grow: 1; /* Ocupa el espacio disponible */
            margin-right: 15px;
        }
        .ep-num { color: var(--accent); margin-right: 8px; }

        .ep-date-group {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            white-space: nowrap; /* Evita que la fecha se parta en dos l√≠neas */
        }

        /* Badge "NUEVO" parpadeante */
        .new-badge {
            background-color: var(--accent-sec);
            color: #000;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            margin-right: 8px;
            animation: pulse 1.5s infinite ease-in-out;
            box-shadow: 0 0 5px var(--accent-sec);
        }

        .ep-desc {
            font-size: 0.95rem;
            color: #ccc;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Limita a 3 l√≠neas la descripci√≥n */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* --- TAGS (Audios/Subt√≠tulos) --- */
        .tags-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
        }
        .tag-group {
            background: #151520;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }
        .tag-icon { margin-right: 6px; }
        .tag-lang { color: white; font-weight: 500; margin-left: 4px;}

        /* --- ANIMACIONES --- */
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.8; } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }

        /* =========================================
           üì± MEDIA QUERY PARA M√ìVILES (Responsive)
           ========================================= */
        @media (max-width: 768px) {
            /* En pantallas peque√±as, cambiamos la direcci√≥n del flex header */
            .ep-header {
                flex-direction: column; /* Apilar verticalmente */
                align-items: flex-start; /* Alinear todo a la izquierda */
            }

            .ep-title-group {
                margin-right: 0;
                margin-bottom: 5px; /* Espacio entre t√≠tulo y fecha */
                width: 100%;
            }

            .ep-date-group {
                width: 100%;
                /* La fecha queda debajo del t√≠tulo */
            }

            .controls-container { flex-direction: column; }
            .control-group { min-width: 100%; }
        }
    </style>
</head>
<body>

<header>
    <h1><span class="bug">üêû</span> Miraculous Global Tracker</h1>
    <div class="last-update" id="last-update">Conectando con la base de datos...</div>
</header>

<div class="controls-container">
    <div class="control-group">
        <label for="country-select">Selecciona Regi√≥n/Territorio:</label>
        <select id="country-select" onchange="handleCountryChange()">
            <option value="" disabled selected>Cargando regiones...</option>
        </select>
    </div>
    
    <div class="control-group">
        <label for="season-select">Filtrar Temporada:</label>
        <select id="season-select" onchange="renderEpisodes()" disabled>
            <option value="all">‚ú® Mostrar Todo</option>
        </select>
    </div>
</div>

<div id="news-banner">
    <h3><span class="news-fire">üî•</span> Novedades detectadas (< 90 d√≠as):</h3>
    <div id="news-list"></div>
</div>

<div id="episodes-container"></div>

<script>
    // =================CONFIGURACI√ìN=================
    // Fecha marcador para ocultar fechas viejas (debe coincidir con el Python)
    const HIDDEN_DATE_MARKER = "2000-01-01"; 
    const DAYS_FOR_NEW = 90; // D√≠as para considerar algo "NUEVO"
    
    // 1. MAPA DE NOMBRES PERSONALIZADOS (Tus correcciones)
    const customCountryNames = {
        "GB": "Reino Unido", // Correcci√≥n del (R.U)
        "FK": "Islas Malvinas (Arg.)", // Nombre espec√≠fico
        // Puedes a√±adir m√°s aqu√≠: "US": "Estados Unidos", etc.
    };

    // 2. MAPA DE BANDERAS PERSONALIZADAS (SVG espec√≠ficos)
    const customFlagURLs = {
        // Bandera de Tierra del Fuego para Malvinas
        "FK": "https://upload.wikimedia.org/wikipedia/commons/9/97/Flag_of_Tierra_del_Fuego_province_in_Argentina.svg",
        // Cruz de Borgo√±a para Gibraltar
        "GI": "https://upload.wikimedia.org/wikipedia/commons/f/f1/Flag_of_Cross_of_Burgundy.svg"
    };
    // ===============================================

    let dbData = null;
    let currentRegion = null;
    const regionNames = new Intl.DisplayNames(['es'], { type: 'region' });

    // --- FUNCIONES AUXILIARES ---

    // Obtener nombre del pa√≠s (con override personalizado)
    function getDisplayName(code) {
        if (customCountryNames[code]) return customCountryNames[code];
        try { return regionNames.of(code); } catch(e) { return code; }
    }

    // Generar HTML de la bandera (CDN est√°ndar o personalizada)
    function getFlagHTML(code) {
        if (customFlagURLs[code]) {
             // Bandera personalizada con clase extra para ajuste de tama√±o
            return `<img src="${customFlagURLs[code]}" alt="${code}" class="flag-icon custom-flag">`;
        }
        // Bandera est√°ndar de flagcdn
        return `<img src="https://flagcdn.com/24x18/${code.toLowerCase()}.png" alt="${code}" class="flag-icon">`;
    }

    // Formatear fecha (YYYY-MM-DD -> DD/MM/YYYY)
    function formatDate(dateStr) {
        if (!dateStr || dateStr === HIDDEN_DATE_MARKER) return "";
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}/${y}`;
    }

    // Verificar si es nuevo
    function isNewEpisode(dateStr) {
        if (!dateStr || dateStr === HIDDEN_DATE_MARKER) return false;
        const epDate = new Date(dateStr);
        const today = new Date();
        const diffTime = Math.abs(today - epDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        return diffDays <= DAYS_FOR_NEW;
    }

    // --- L√ìGICA PRINCIPAL ---

    async function init() {
        try {
            const response = await fetch('database.json?v=' + new Date().getTime()); // Evitar cach√©
            if (!response.ok) throw new Error("No se pudo cargar database.json");
            dbData = await response.json();
            
            document.getElementById('last-update').textContent = `üìÖ √öltima actualizaci√≥n de datos: ${dbData.meta.updated}`;
            populateCountrySelect();
        } catch (error) {
            document.getElementById('last-update').innerHTML = `<span style="color:red">Error: ${error.message}. Verifica que database.json est√© en la carpeta.</span>`;
        }
    }

    function populateCountrySelect() {
        const countrySelect = document.getElementById('country-select');
        countrySelect.innerHTML = '<option value="" disabled selected>Selecciona una regi√≥n...</option>';
        
        const regionCodes = Object.keys(dbData.regions).sort((a, b) => {
            return getDisplayName(a).localeCompare(getDisplayName(b));
        });

        regionCodes.forEach(code => {
            const option = document.createElement('option');
            option.value = code;
            // Nota: Los <option> nativos no soportan im√°genes (banderas) f√°cilmente.
            // El nombre se muestra corregido.
            option.textContent = getDisplayName(code); 
            countrySelect.appendChild(option);
        });
    }

    function handleCountryChange() {
        currentRegion = document.getElementById('country-select').value;
        const seasonSelect = document.getElementById('season-select');
        seasonSelect.disabled = false;
        
        // Poblar selector de temporadas
        const seasons = dbData.regions[currentRegion].seasons.map(s => s.id);
        seasonSelect.innerHTML = '<option value="all">‚ú® Mostrar Todo</option>';
        seasons.forEach(sId => {
            seasonSelect.innerHTML += `<option value="${sId}">Temporada ${sId}</option>`;
        });

        renderNewsBanner();
        renderEpisodes();
    }

    function renderNewsBanner() {
        const banner = document.getElementById('news-banner');
        const list = document.getElementById('news-list');
        const news = dbData.regions[currentRegion].news || [];

        if (news.length === 0) {
            banner.style.display = 'none';
            return;
        }

        list.innerHTML = '';
        // Mostrar solo las √∫ltimas 5 novedades para no saturar
        news.slice(0, 5).forEach(item => {
            list.innerHTML += `<span class="news-pill">${item.e} - ${item.t} (${formatDate(item.d)})</span>`;
        });
        banner.style.display = 'block';
    }

    function renderEpisodes() {
        const container = document.getElementById('episodes-container');
        container.innerHTML = '';
        
        const selectedSeasonStr = document.getElementById('season-select').value;
        const regionData = dbData.regions[currentRegion];

        regionData.seasons.forEach(season => {
            if (selectedSeasonStr !== 'all' && season.id.toString() !== selectedSeasonStr) return;

            container.innerHTML += `<div class="season-separator">Temporada ${season.id}</div>`;

            season.eps.forEach(ep => {
                const isNew = isNewEpisode(ep.dt);
                const displayDate = formatDate(ep.dt);
                
                // HTML de la fecha: Si est√° oculta, no se muestra nada.
                let dateHTML = '';
                if (displayDate) {
                    const newBadgeHtml = isNew ? '<span class="new-badge">¬°NUEVO!</span>' : '';
                    dateHTML = `<div class="ep-date-group">${newBadgeHtml}üìÖ ${displayDate}</div>`;
                }

                let audiosHTML = ep.a.length ? `<div class="tag-group"><span class="tag-icon">üîä</span> ${ep.a.map(a => `<span class="tag-lang">${a}</span>`).join(', ')}</div>` : '';
                let subsHTML = ep.s.length ? `<div class="tag-group"><span class="tag-icon">üìù</span> ${ep.s.map(s => `<span class="tag-lang">${s.l}</span>`).join(', ')}</div>` : '';

                const cardHtml = `
                    <div class="ep-card ${isNew ? 'is-new' : ''}">
                        <div class="ep-header">
                            <div class="ep-title-group">
                                <span class="ep-num">T${season.id} E${ep.n}</span> ${ep.t}
                            </div>
                            ${dateHTML} </div>
                        <div class="ep-desc">${ep.ds || 'Sin descripci√≥n disponible.'}</div>
                        <div class="tags-container">
                            ${audiosHTML}
                            ${subsHTML}
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        });
    }

    // Iniciar APP
    init();

</script>
</body>
</html>
